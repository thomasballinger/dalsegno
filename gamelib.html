<html>
<body>
<textarea id="code" rows="20" cols="40">
  (do 
    (define x 100)
    (define y 100)
    (display "hi!")
    (defn render (do
      (clearDrawRect x y 100 100)
      (set! x (+ x 1))
      (render)))
    (render))
</textarea>
<canvas id="canvas" width="300" height="300"></canvas>
    
<script src="gamelib.js"></script>
<script src="objeval.js"></script>
<script src="parse.js"></script>
<script>
  var lib = new Gamelib('canvas');
  var gameMethods = lib.getFunctions();
  gameMethods.drawRect(100, 100, 40, 50);

  var textArea = document.getElementById('code');

  env = new Environment([gameMethods, builtins, {}]);
  var shouldReload = true;
  var running = true;
  var lastProgram = [];

  textArea.addEventListener('keyup', function(){
    shouldReload = true;
    if (!running){
      runAtInterval(textArea.value, env, 0.001, 1, runCallback);
    }
  })

  var runCallback = function(){
    if (shouldReload){
      shouldReload = false;
      var program = textArea.value;

      try {
        parse(program);
      } catch (e) {
        console.log(e)
        running = false;
        return false;
      }

      if (running && JSON.stringify(parse(program)) === JSON.stringify(lastProgram)){
        return true;
      }
      lastProgram = parse(program);
      running = true;
      env = new Environment([gameMethods, builtins, {}]);
      runAtInterval(program, env, 0.001, 1, runCallback)
      return false;
    } else {
      return true;
    }
  }

  runAtInterval(textArea.value, env, 0.001, 1, runCallback);


</script>
</body>
</html>

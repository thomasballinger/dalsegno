<html>
<head>
<title>live code reloading eventually</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    #canvas {
      z-index: 2;
    }
    .ace-monokai {
      opacity: .8;
    }
</style>
</head>
<body>

<div id="editor">(do 
  (display (randint -5 6))
  (define x 100)
  (define y 100)
  (display "we_are_running")
  (defn init-world 
    (map (lambda i 
           (list
             (list (randint 200) (randint 200))
             (list (randint -5 6) (randint -5 6))))
         (range 10)))
  (define world (init-world))
  (defn step-obj obj 
    (list
      (list (+ (first (first obj)) (first (last obj)))
            (+ (last (first obj)) (last (last obj))))
      (last obj)))
  (defn nearby obj
    (do
      (< (dist x y (nth 0 (first obj)) (nth 1 (first obj))) 500)))
  (defn to-render (filter nearby world))
  (defn render-obj obj (do
    (define radius 20)
    (drawCircle (first (first obj))
              (nth 1 (first obj))
              radius)))
  (defn render (do
    (clear)
    (drawRect x y 100 100)
    (map render-obj (to-render))
    (set! world (map step-obj world))
    (display (first world))
    (set! x (+ x 1))
    (set! y (/ (* x x) 200))
    (if (> x 200) (set! x 100))
    (display (to-render))
    (render)))
  (render))</div>
<div>
    
<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/scheme");
    var options = window.location.hash.substr(1);
    if (options.indexOf('vim') != -1){
      editor.setKeyboardHandler("ace/keyboard/vim");
    }
</script>

<canvas id="canvas" width="1" height="1"></canvas>
<script>
  var canvas = document.getElementById('canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
</script>
    
<script src="parse.js"></script>
<script src="run.js"></script>
<script src="builtins.js"></script>
<script src="gamelib.js"></script>
<script src="stdlib.js"></script>
<script>
  var speed = 100;
  editor.getSession().on('change', function(e) {
    shouldReload = true;
    if (!running){
      run.runAtInterval(editor.getValue(), env, 0, speed, runCallback, errback);
    }
  });

  var lib = new Gamelib('canvas');
  var gameMethods = lib.getFunctions();
  gameMethods.drawRect(100, 100, 40, 50);

  var buildEnv = function(){
    return new run.Environment([gameMethods, builtins, stdlib, {}]);
  };
  var env = buildEnv();
  var shouldReload = true;
  var running = true;
  var lastProgram = [];


  var safelyParses = function(program){
    try {
      parse(program);
      return true;
    } catch (e) {
      console.log(e)
      return false;
    }
  }


  var runCallback = function(){
    if (shouldReload){
      shouldReload = false;
      var program = editor.getValue() 

      if (!safelyParses(program)){
        running = false;
        return false
      }

      if (running && JSON.stringify(parse(program)) === JSON.stringify(lastProgram)){
        return true;
      }
      lastProgram = parse(program);
      running = true;
      env = buildEnv();
      run.runAtInterval(program, env, 0, speed, runCallback, errback)
      return false;
    } else {
      return true;
    }
  }

  var errback = function(e){
    console.log(e);
    running = false;
  }

  run.runAtInterval(editor.getValue(), env, 0, speed, runCallback, errback);


</script>
</body>
</html>

<html>
<head>
<title>live code reloading eventually</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    #canvas {
      z-index: 2;
    }
    .ace-monokai {
      opacity: .9;
    }
</style>
</head>
<body>

<div id="editor">(do 
  (define x 100)
  (define y 100)
  (display "we_are_running")
  (defn world (list
    (list 50 200)
    (list 50 0)))
  (defn nearby obj
    (do
      (< (dist x y (nth 0 obj) (nth 1 obj)) 120)))
  (defn to-render (filter nearby (world)))
  (defn render-obj obj (do
    (display "renderingobj" (first obj) (nth 1 obj))
    (define radius 50)
    (drawRect (- (first obj) radius)
              (- (nth 1 obj) radius)
              (* 2 radius)
              (* 2 radius))))
  (defn render (do
    (clear)
    (drawRect x y 100 100)
    (map render-obj (to-render))
    (set! x (+ x 1))
    (set! y (/ (* x x) 200))
    (if (> x 200) (set! x 100))
    (display (to-render))
    (render)))
  (render))</div>
<div>
    
<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/scheme");
    var options = window.location.hash.substr(1);
    if (options.indexOf('vim') != -1){
      editor.setKeyboardHandler("ace/keyboard/vim");
    }
</script>

<canvas id="canvas" width="300" height="300"></canvas>
    
<script src="parse.js"></script>
<script src="run.js"></script>
<script src="builtins.js"></script>
<script src="gamelib.js"></script>
<script src="stdlib.js"></script>
<script>
  editor.getSession().on('change', function(e) {
    shouldReload = true;
    if (!running){
      run.runAtInterval(editor.getValue(), env, 0.001, 1, runCallback, errback);
    }
  });

  var lib = new Gamelib('canvas');
  var gameMethods = lib.getFunctions();
  gameMethods.drawRect(100, 100, 40, 50);

  var buildEnv = function(){
    return new run.Environment([gameMethods, builtins, stdlib, {}]);
  };
  var env = buildEnv();
  var shouldReload = true;
  var running = true;
  var lastProgram = [];


  var safelyParses = function(program){
    try {
      parse(program);
      return true;
    } catch (e) {
      console.log(e)
      return false;
    }
  }


  var runCallback = function(){
    if (shouldReload){
      shouldReload = false;
      var program = editor.getValue() 

      if (!safelyParses(program)){
        running = false;
        return false
      }

      if (running && JSON.stringify(parse(program)) === JSON.stringify(lastProgram)){
        return true;
      }
      lastProgram = parse(program);
      running = true;
      env = buildEnv();
      run.runAtInterval(program, env, 0, 3, runCallback, errback)
      return false;
    } else {
      return true;
    }
  }

  var errback = function(e){
    console.log(e);
    running = false;
  }

  run.runAtInterval(editor.getValue(), env, 0.001, 1, runCallback, errback);


</script>
</body>
</html>

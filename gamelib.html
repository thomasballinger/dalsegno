<html>
<head>
<meta charset="UTF-8">
<title>live code reloading</title>
<style type="text/css" media="screen">
    #editor {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        width: 630px;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 630px;
      bottom: 0;
      right: 0;
      background-color: #777777;
    }
    .is-hidden {
      display: none;
    }
    #errorbar {
      position: absolute;
      top: 100;
      left: 660px;
      bottom: 100;
      right: 30;
      background-color: #ff99cc;
      text-align: center;
      font-size: 2em;
    }
    .errorHighlight{
      position:absolute;
      z-index:20;
      background-color:#F4B9B7;
    }
    body {
      background-color: #111111
    }
</style>
</head>
<body>

<div id="space-program" class="is-hidden">; That headlight looks a little underpowered!
; Try changing the last two arguments to draw-black
; on line 74, or delete that line altogether.
; Then make more changes to see how the game works!
; Language documentation:
; https://github.com/thomasballinger/dalsegno#user-content-language

(do
  (defn init-world
    (map (lambda i
           (list
             (list (randint 200) (randint 200))
             (list (randint -5 6) (randint -5 6))))
         (range 10)))

  (defn wrap-obj obj
    (list
      (list (% (first (first obj)) width)
            (% (last (first obj)) height))
      (last obj)))

  (defn step-obj obj
    (list
      (list (+ (first (first obj)) (first (last obj)))
            (+ (last (first obj)) (last (last obj))))
      (last obj)))

  (defn render-obj obj (do
    (color 110 45 2)
    (define radius 20)
    (drawArc (first (first obj))
              (nth 1 (first obj))
              radius)))

  (defn draw-black x y h d angle (do
      (color 0 0 0)
      (drawArc x y 1000 (+ h 180 angle) (+ h angle))
      (drawArc x y 1000 (- h angle) (- (+ h 180) angle))
      (drawInverseCircle x y d)))

  (defn game (do
    (define x 300)
    (define y 300)
    (define vx 1)
    (define vy 1)
    (display "game started")
    (define world (init-world))
    (defn nearby obj
      (< (dist x y (first (first obj)) (nth 1 (first obj))) 300))
    (defn collide obj
      (< (dist x y (first (first obj)) (nth 1 (first obj))) 23))
    (defn any-collide (reduce or (map collide world) 0))
    (defn to-render world)
    (define counter 0)
    (defn on-click (do
      (define towards-mouse (towards x y (mousex) (mousey)))
      (set! vx (+ vx (* (x_comp towards-mouse) .5)))
      (set! vy (+ vy (* (y_comp towards-mouse) .5)))
      (color 200 150 0)
      (drawPoly x y
        (list (list -13 -10)
              (list -9 -10)
              (list -9 10)
              (list -13 10))
        (towards x y (mousex) (mousey)))))

    (defn main (do
      (define h (towards x y (mousex) (mousey)))
      (color 200 200 30)
      (fillRect 0 0 width height)
      (color 40 40 100)
      (map render-obj (to-render))

      (draw-black x y h 100 25)  ;change this line!

      (color 30 100 200)
      (drawPoly x y
        (list (list 15 0) (list -10 -12) (list -10 12))
        (towards x y (mousex) (mousey)))

      (set! world (map step-obj world))
      (set! world (map wrap-obj world))
      (if (clicked) (on-click))
      (set! x (+ x vx))
      (set! y (+ y vy))
      (if (> x width) (set! x 0))
      (if (> y height) (set! y 0))
      (if (< x 0) (set! x width))
      (if (< y 0) (set! y height))
      (render 200 200 1)
      (if (not (any-collide))
          (do
            (set! counter (+ counter 1))
            (main))
          (do
            (map render-obj (to-render))
            (drawText 100 100 "your" "score:" counter)
            (render)
            ))))
      (main)))

  (defn wait-for-unclick
    (if (clicked)
        (wait-for-unclick)))
  (defn wait-for-click
    (if (not (clicked))
        (wait-for-click)))
  (defn play-forever (do
    (game)
    (wait-for-unclick)
    (wait-for-click)
    (play-forever)))
  (play-forever))</div>

<div id="editor" class="is-hidden"></div>

<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="Immutable.js" type="text/javascript" charset="utf-8"></script>
<script>
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1]);
}
</script>

<script>
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/scheme");
  var options = window.location.hash.substr(1);
  if (getParameterByName('vim')){
    editor.setKeyboardHandler("ace/keyboard/vim");
  }
  editor.commands.removeCommand('gotoline') // bound to command-L which selects the url in osx chrome
  editor.getSession().setTabSize(2);
  editor.getSession().setUseSoftTabs(true);
  editor.$blockScrolling = Infinity
  document.getElementById('editor').style.fontSize='16px';

  var editorContainer = document.getElementById('editor');
  editorContainer.classList.remove('is-hidden');

  var code = getParameterByName('code');
  if (code) {
    editor.setValue(code);
  } else {
    editor.setValue(document.getElementById('space-program').textContent)
  }

  var updateUrl = function(){
    var encoded = encodeURI(editor.getValue());
    try {
      history.replaceState({}, "", "?code="+encoded);
    }catch(e){
      console.log('failed to change url');
    }
  };
</script>

<canvas id="canvas" width="1" height="1"></canvas>
<div id="errorbar"></div>
<script>
  var canvas = document.getElementById('canvas');
  canvas.width = window.innerWidth - 630;
  canvas.height = window.innerHeight;
</script>

<script src="deepCopy.js"></script>
<script src="parse.js"></script>
<script src="Environment.js"></script>
<script src="compile.js"></script>
<script src="bcexec.js"></script>
<script src="bcrun.js"></script>
<script src="builtins.js"></script>
<script src="MouseTracker.js"></script>
<script src="KeyboardTracker.js"></script>
<script src="stdlibcode.js"></script>
<script src="bcstdlib.js"></script>
<script src="LazyCanvasCtx.js"></script>
<script src="DrawHelpers.js"></script>
<script>
  var DEBUGMODE = false;

  var shouldReload = true; // on next tick, reload the program
  var currentlyRunning = false; // if not, change event needs to kick off runner
  var lazyCanvasCtx = new LazyCanvasCtx('canvas', true);
  var mouseTracker = new MouseTracker('canvas');
  var keyboardTracker = new KeyboardTracker('canvas');
  var drawHelpers = new DrawHelpers(lazyCanvasCtx, document.getElementById('canvas'));
  var envBuilder = function(){
    return new Environment([
    window, console, canvas, lazyCanvasCtx, drawHelpers, mouseTracker, keyboardTracker, new Environment.Scope(builtins), new Environment.Scope(bcstdlib), new Environment.Scope()]);
  };
  var runner = new bcrun.BCRunner({});
  runner.setEnvBuilder(envBuilder);
  var lastProgram = '';

  var speed = 500;

  var errorbar = document.getElementById('errorbar');

  var badSpot;
  var errback = function(e){
    errorbar.innerText = ''+e;
    errorbar.classList.remove('is-hidden');
    if (e.ast){
      Range = ace.require("ace/range").Range
      badSpot = editor.session.addMarker(new Range(
        e.ast.lineStart-1,
        e.ast.colStart-1,
        e.ast.lineEnd-1,
        e.ast.colEnd-1), "errorHighlight");
    }
  }
  var clearError = function(){
    errorbar.classList.add('is-hidden');
    if (badSpot){
      editor.getSession().removeMarker(badSpot)
      badSpot = undefined;
    }
  }

  var runABit = function(){
    var s = editor.getValue();
    if (shouldReload){
      clearError()
      shouldReload = false;
      if (parse.safelyParses(s, errback)){
        runner.update(s);
        currentlyRunning = runner.runABit(1, errback);
      } else {
        currentlyRunning = false;
        return;
      }
    }
    if (currentlyRunning) {
      currentlyRunning = runner.runABit(speed, errback);
      if (currentlyRunning) {
        setTimeout(runABit, 0);
      }
    }
  }

  var onChange = function(e){
    var s = editor.getValue();
    if (!parse.safelyParses(s, errback)){
      lastProgram = '';
      currentlyRunning = false;
      return;
    }

    updateUrl();

    var newProgram = JSON.stringify(parse(s));
    if (newProgram === lastProgram){
      return;
    }
    lastProgram = newProgram;
    shouldReload = true;
    if (!currentlyRunning){
      currentlyRunning = true;
      runABit();
    }
  };

  editor.getSession().on('change', onChange);

  shouldReload = true;
  currentlyRunning = true;
  runABit();
</script>
</body>
</html>

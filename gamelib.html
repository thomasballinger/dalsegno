<html>
<head>
<meta charset="UTF-8">
<title>live code reloading</title>
<style type="text/css" media="screen">
    #editor {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        width: 630px;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 630px;
      bottom: 0;
      right: 0;
      background-color: #777777;
    }
    .is-hidden {
      display: none;
    }
    #errorbar {
      position: absolute;
      top: 100;
      left: 660px;
      bottom: 100;
      right: 30;
      background-color: #ff99cc;
      text-align: center;
      font-size: 2em;
    }
    .errorHighlight{
      position:absolute;
      z-index:20;
      background-color:#F4B9B7;
    }
    body {
      background-color: #111111
    }
</style>
</head>
<body>

<div id="editor" class="is-hidden"></div>
<script src="examples/spacelight.js" type="text/javascript" charset="utf-8"></script>

<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="Immutable.js" type="text/javascript" charset="utf-8"></script>
<script>
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1]);
}
</script>

<script>
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/scheme");
  var options = window.location.hash.substr(1);
  if (getParameterByName('vim')){
    editor.setKeyboardHandler("ace/keyboard/vim");
  }
  editor.commands.removeCommand('gotoline') // bound to command-L which selects the url in osx chrome
  editor.getSession().setTabSize(2);
  editor.getSession().setUseSoftTabs(true);
  editor.$blockScrolling = Infinity
  document.getElementById('editor').style.fontSize='16px';

  var editorContainer = document.getElementById('editor');
  editorContainer.classList.remove('is-hidden');

  var code = getParameterByName('code');
  if (code) {
    editor.setValue(code);
  } else {
    editor.setValue(window.spaceLightProgram);
  }

  var updateUrl = function(){
    var encoded = encodeURI(editor.getValue());
    try {
      history.replaceState({}, "", "?code="+encoded);
    }catch(e){
      console.log('failed to change url');
    }
  };
</script>

<canvas id="canvas" width="1" height="1"></canvas>
<div id="errorbar"></div>
<script>
  var canvas = document.getElementById('canvas');
  canvas.width = window.innerWidth - 630;
  canvas.height = window.innerHeight;
</script>

<script src="deepCopy.js"></script>
<script src="parse.js"></script>
<script src="Environment.js"></script>
<script src="compile.js"></script>
<script src="bcexec.js"></script>
<script src="bcrun.js"></script>
<script src="builtins.js"></script>
<script src="MouseTracker.js"></script>
<script src="KeyboardTracker.js"></script>
<script src="stdlibcode.js"></script>
<script src="bcstdlib.js"></script>
<script src="LazyCanvasCtx.js"></script>
<script src="DrawHelpers.js"></script>
<script>
  var DEBUGMODE = false;

  var shouldReload = true; // on next tick, reload the program
  var currentlyRunning = false; // if not, change event needs to kick off runner
  var lazyCanvasCtx = new LazyCanvasCtx('canvas', true, true);
  var mouseTracker = new MouseTracker('canvas');
  var keyboardTracker = new KeyboardTracker('canvas');
  var drawHelpers = new DrawHelpers(lazyCanvasCtx, document.getElementById('canvas'));
  var envBuilder = function(){
    return new Environment([
    window, console, canvas, lazyCanvasCtx, drawHelpers, mouseTracker, keyboardTracker, new Environment.Scope(builtins), new Environment.Scope(bcstdlib), new Environment.Scope()]);
  };
  var runner = new bcrun.BCRunner({});
  runner.setEnvBuilder(envBuilder);
  var lastProgram = '';

  //TODO alter speed to try to get 30fps?
  var speed = 500;

  var errorbar = document.getElementById('errorbar');

  var badSpot;
  var errback = function(e){
    errorbar.innerText = ''+e;
    errorbar.classList.remove('is-hidden');
    if (e.ast){
      Range = ace.require("ace/range").Range
      badSpot = editor.session.addMarker(new Range(
        e.ast.lineStart-1,
        e.ast.colStart-1,
        e.ast.lineEnd-1,
        e.ast.colEnd-1), "errorHighlight");
    }
  }
  var clearError = function(){
    errorbar.classList.add('is-hidden');
    if (badSpot){
      editor.getSession().removeMarker(badSpot)
      badSpot = undefined;
    }
  }

  var runABit = function(){
    var s = editor.getValue();
    if (shouldReload){
      clearError()
      shouldReload = false;
      if (parse.safelyParses(s, errback)){
        runner.update(s);
        currentlyRunning = runner.runABit(1, errback);
      } else {
        currentlyRunning = false;
        return;
      }
    }
    if (currentlyRunning) {
      currentlyRunning = runner.runABit(speed, errback);
      if (currentlyRunning) {
        setTimeout(runABit, 0);
      }
    }
  }

  var onChange = function(e){
    var s = editor.getValue();
    if (!parse.safelyParses(s, errback)){
      lastProgram = '';
      currentlyRunning = false;
      return;
    }

    updateUrl();

    var newProgram = JSON.stringify(parse(s));
    if (newProgram === lastProgram){
      return;
    }
    lastProgram = newProgram;
    shouldReload = true;
    if (!currentlyRunning){
      currentlyRunning = true;
      runABit();
    }
  };

  editor.getSession().on('change', onChange);

  shouldReload = true;
  currentlyRunning = true;
  runABit();
</script>
</body>
</html>

<html>
<head>
<meta charset="UTF-8">
<title>live code reloading</title>
<link rel="stylesheet" href="dalsegno.css">
<style>
#embed {
  position: relative;
  width: 800px;
  height: 400px;
}
#editor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  width: 300px;
  font-size: 8px;
}
#canvas {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  width: 500px;
  height: 400px;
}
</style>
</head>
<body>
<h1>Embedding Dal Segno</h1>

<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="Immutable.js" type="text/javascript" charset="utf-8"></script>
<script src="DalSegno.js" type="text/javascript" charset="utf-8"></script>

<script>
setUpDalSegno('editor', 'canvas', 'errorbar', 'space-program', function(embed){
  embed.style
  document.getElementById(embed.editorId).style.fontSize='10px';
  embed.go();
});
</script>

<div id="embed">
  <div id="editor" class="editor is-hidden"></div>
  <canvas id="canvas" width="1" height="1"></canvas>
  <div id="errorbar"></div>
</div>

<div id="space-program" class="is-hidden">; That headlight looks a little underpowered!
; Try changing the last two arguments to draw-black
; on line 74, or delete that line altogether.
; Then make more changes to see how the game works!
; Language documentation:
; https://github.com/thomasballinger/dalsegno#user-content-language

(do
  (defn init-world
    (map (lambda i
           (list
             (list (randint 200) (randint 200))
             (list (randint -5 6) (randint -5 6))))
         (range 10)))

  (defn wrap-obj obj
    (list
      (list (% (first (first obj)) width)
            (% (last (first obj)) height))
      (last obj)))

  (defn step-obj obj
    (list
      (list (+ (first (first obj)) (first (last obj)))
            (+ (last (first obj)) (last (last obj))))
      (last obj)))

  (defn render-obj obj (do
    (color 110 45 2)
    (define radius 20)
    (drawArc (first (first obj))
              (nth 1 (first obj))
              radius)))

  (defn draw-black x y h d angle (do
      (color 0 0 0)
      (drawArc x y 1000 (+ h 180 angle) (+ h angle))
      (drawArc x y 1000 (- h angle) (- (+ h 180) angle))
      (drawInverseCircle x y d)))

  (defn game (do
    (define x 300)
    (define y 300)
    (define vx 1)
    (define vy 1)
    (display "game started")
    (define world (init-world))
    (defn nearby obj
      (< (dist x y (first (first obj)) (nth 1 (first obj))) 300))
    (defn collide obj
      (< (dist x y (first (first obj)) (nth 1 (first obj))) 23))
    (defn any-collide (reduce or (map collide world) 0))
    (defn to-render world)
    (define counter 0)
    (defn on-click (do
      (define towards-mouse (towards x y (mousex) (mousey)))
      (set! vx (+ vx (* (x_comp towards-mouse) .5)))
      (set! vy (+ vy (* (y_comp towards-mouse) .5)))
      (color 200 150 0)
      (drawPoly x y
        (list (list -13 -10)
              (list -9 -10)
              (list -9 10)
              (list -13 10))
        (towards x y (mousex) (mousey)))))

    (defn main (do
      (define h (towards x y (mousex) (mousey)))
      (color 200 200 30)
      (fillRect 0 0 width height)
      (color 40 40 100)
      (map render-obj (to-render))

      (draw-black x y h 100 25)  ;change this line!

      (color 30 100 200)
      (drawPoly x y
        (list (list 15 0) (list -10 -12) (list -10 12))
        (towards x y (mousex) (mousey)))

      (set! world (map step-obj world))
      (set! world (map wrap-obj world))
      (if (clicked) (on-click))
      (set! x (+ x vx))
      (set! y (+ y vy))
      (if (> x width) (set! x 0))
      (if (> y height) (set! y 0))
      (if (< x 0) (set! x width))
      (if (< y 0) (set! y height))
      (render 200 200 1)
      (if (not (any-collide))
          (do
            (set! counter (+ counter 1))
            (main))
          (do
            (map render-obj (to-render))
            (drawText 100 100 "your" "score:" counter)
            (render)
            ))))
      (main)))

  (defn wait-for-unclick
    (if (clicked)
        (wait-for-unclick)))
  (defn wait-for-click
    (if (not (clicked))
        (wait-for-click)))
  (defn play-forever (do
    (game)
    (wait-for-unclick)
    (wait-for-click)
    (play-forever)))
  (play-forever))</div>
</body>
</html>
